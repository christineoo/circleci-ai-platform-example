version: 2.1
orbs:
  jq: circleci/jq@1.9.0
jobs:
  build:
    docker:
      - image: google/cloud-sdk
    working_directory: ~/circleci-ai-platform-example
    steps:
      - checkout
      - jq/install
      - run: |
          echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
          gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
          gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
          gcloud ai-platform jobs list

      - run:
          name: submit training jobs
          command: |
            gcloud ai-platform jobs submit training christineoo_test2 \
              --job-dir gs://${GCS_BUCKET_NAME}/christineoo_test \
              --runtime-version 2.1 \
              --python-version 3.7 \
              --module-name trainer.task \
              --package-path trainer/ \
              --region ${GOOGLE_COMPUTE_ZONE}

      - run:
          name: check job status
          command: |
              bash ./job_status.sh ${GOOGLE_PROJECT_ID} christineoo_test2
